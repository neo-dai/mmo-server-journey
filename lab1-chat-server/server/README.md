# Chat Server (C++)

一个支持多用户聊天的 C++ 服务器，实现基础的消息广播功能。

## 功能特性

- ✅ TCP Socket 服务器
- ✅ 多客户端并发连接（使用多线程）
- ✅ 消息广播：用户发送的消息会广播给所有其他用户
- ✅ 用户上线/下线通知
- ✅ 自动用户标识（使用 IP:Port）
- ✅ 线程安全的用户列表管理

## 学习重点

这个版本在 v0.2 基础上增加了聊天室功能：
- 连接池管理（维护在线用户列表）
- 消息广播机制
- 用户上线/下线通知
- 线程安全的共享资源管理

## 版本历史

- **v0.1**: 单客户端 Echo Server
- **v0.2**: 多客户端 Echo Server（读写分离）
- **v0.3** (当前): 聊天室服务器（消息广播）

## 编译

### 使用 CMake

```bash
mkdir build
cd build
cmake ..
make
```

### 手动编译

```bash
g++ -std=c++11 -pthread -o echo_server echo_server.cpp
```

## 运行

```bash
./echo_server [端口号]
```

默认端口为 8080。例如：

```bash
# 使用默认端口 8080
./echo_server

# 使用自定义端口
./echo_server 3000
```

## 测试

### 使用多个客户端程序测试

```bash
# 终端1：启动服务器
cd server/build
./echo_server

# 终端2：启动客户端1
cd client/build
./echo_client

# 终端3：启动客户端2
cd client/build
./echo_client

# 终端4：启动客户端3
cd client/build
./echo_client
```

在客户端中发送消息，所有其他客户端都会收到广播。

### 使用 telnet 测试

```bash
# 可以同时打开多个终端连接
telnet localhost 8080
```

连接后，输入任何消息，所有其他连接的客户端都会收到。

## 消息格式

### 用户标识

服务器使用 `IP:Port` 格式自动标识每个用户，例如：
- `127.0.0.1:54321`
- `192.168.1.100:54322`

### 消息格式

**用户消息**：
```
[127.0.0.1:54321] Hello everyone!
```

**系统通知**：
```
[系统] 127.0.0.1:54322 加入了聊天室
[系统] 127.0.0.1:54321 离开了聊天室
```

## 架构说明

- **多线程模型**：每个客户端连接使用独立的线程处理
- **连接池管理**：使用 `std::vector<ClientInfo>` 维护在线用户列表
- **线程安全**：使用 `std::mutex` 保护共享资源（用户列表、日志）
- **消息广播**：用户发送消息时，服务器广播给所有其他用户

## 代码结构

- `ClientInfo` 结构体：存储客户端信息（socket, user_id）
- `clients` 列表：维护所有在线用户
- `broadcast_message()`：广播消息给所有用户（排除发送者）
- `add_client()` / `remove_client()`：管理用户列表

## 工作流程

1. 客户端连接
2. 服务器自动生成用户标识（IP:Port）
3. 添加到在线用户列表
4. 通知所有其他用户：新用户加入
5. 接收用户消息并广播给所有其他用户
6. 用户断开时，从列表移除并通知其他用户

## 下一步

- [ ] 添加 JSON 消息协议支持
- [ ] 实现分组/频道功能
- [ ] 添加私聊功能
- [ ] 支持 Web 客户端
